# Unity DXR Path Tracing

Unity でパストレを映像プロジェクト制作に使った感想と、そこで得られた知見について。

## 映像プロジェクト

https://github.com/keijiro/Sketch0907

Unite 2022 キービジュアル。約３０秒の動画と、約５秒のシームレスループ動画、スチル素材数枚を制作。

## プロシージャルモデリング

Unity DXR は `DrawMesh` 系の描画 API に対応していないため、メッシュの描画には基本的に `MeshRenderer` を介する必要がある。

この条件において、プロシージャルモデリングを使った複雑なシーンを構築するには、以下のようなアプローチが考えられる。

- `MeshRenderer` をプールして大量使用するための仕組みを作る。
- 結合メッシュを毎フレーム生成・更新する仕組みを作る。

コード的には後者の方が簡潔にまとめやすい。ただ、どうしてもメッシュ更新のコストがかかってしまう。配列コピーの負荷が無視できない規模になるほか、法線生成のコストも重くかかってくる。New Mesh API の導入によってこれを回避できないかどうか検討中。

## マテリアル表現

個人的には、パストレによる反射・透過の表現を専ら模索しているので、複雑なマテリアル表現については検討を行っていない。

上記プロジェクトでは UV0 に発光量を仕込むことにより、単一メッシュ内での自己発光表現の使用を可能にした。こういった対応をシェーダーグラフで簡単に実現できるのは本当に便利。

ただ、DXR パストレではシェーダーグラフの Custom Interpolator を使えないという弱点がある（これは意図された仕様）。本来ならば自己発光量などは Custom Interpolator で対応すべきだが、この制約のため UV0 を転用することになった。

## ノイズ抑制

デノイザの搭載によって DXR パストレが実用的なものになった。もちろん上記のプロジェクトでもガンガン使っている。

DLSS と OID の２種類が使用可能だが、速度重視なら DLSS、画質重視なら OID という選択になる。パストレの場合、もとよりレンダリングに時間がかかることは折り込み済みなので、僅かな時間を DLSS で稼ぐよりも、画質優先で専ら OID を用いていくことになるか。

上記プロジェクトでは 300 サンプルと IOD の組み合わせで最終レンダリングを行った。これでもまだムラは残るが、サンプル数増強による画質の改善は既に難しいレベルにあり、家庭内レンダリング環境ではほぼ限界かと思われる。

## GPU メモリ問題

上記プロジェクトでは GPU メモリが足りなくなる問題が多発した。明示的にエラーになるわけではないが、Recorder を使用したレンダリングをしばらく続けていると極端な速度低下が発生する。Task Manager で確認する限り、GPU メモリが枯渇している状態にあると推測される。

これを回避するために、数秒毎の短いパートに分けてレンダリングを行い、外部ソフト (DaVinci Resolve) で編集・結合することになった。

また、8K 解像度でレンダリングしようとするとクラッシュする。これは恐らく単純なメモリ不足だろう。

これらのメモリ問題についてはバグ報告の必要がある。
コード的には後者の方が簡潔にまとめやすい。ただ、どうしてもメッシュ更新のコストがかかってしまう。配列コピーの負荷が無視できない規模になるほか、法線生成のコストも重くかかってくる。New Mesh API の導入によってこれを回避できないかどうか検討中。
