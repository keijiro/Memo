# Unity DXR Path Tracing

Unity でパストレを映像プロジェクト制作に使った感想と、そこで得られた知見について。

## 映像プロジェクト

https://github.com/keijiro/Sketch0907

Unite 2022 キービジュアル。約３０秒の動画と、約５秒のシームレスループ動画、スチル素材数枚を制作。

## プロシージャルモデリング

Unity DXR は `DrawMesh` 系の描画 API に対応していないため、メッシュの描画には基本的に `MeshRenderer` を介する必要がある。

この条件において、プロシージャルモデリングを使った複雑なシーンを構築するには、以下のようなアプローチが考えられる。

- `MeshRenderer` をプールして大量使用するための仕組みを作る。
- 結合メッシュを毎フレーム生成・更新する仕組みを作る。

コード的には後者の方が簡潔にまとめやすい。ただ、どうしてもメッシュ更新のコストがかかってしまう。配列コピーの負荷が無視できない規模になるほか、法線生成のコストも重くかかってくる。New Mesh API の導入によってこれを回避できないかどうか検討中。

## マテリアル表現

個人的にはパストレによる反射・透過の表現を模索中なので、複雑なマテリアル表現については未検討。

上記作例では `TexCoord0` に発光量を仕込むことにより単一メッシュ内での自己発光表現を可能にした。こういうのをシェーダーグラフでサクッと作れるのは本当に便利。

ただ、シェーダーグラフの Custom Interpolator を使えないという弱点がある（これは意図された仕様）。本来なら自己発光量などは Custom Interpolator にすべきだが、この制約のため `TexCoord0` に入れることになった。

## ノイズ抑制

デノイザの搭載によってパストレが実用的なものになった。もちろん実際のプロジェクトでもガンガンに使っていく。

DLSS と OID の２種類が使用可能だが、速度重視なら DLSS、画質重視なら OID という選択になると思われる。パストレの場合ある程度の時間がかかることは折り込み済みなので、もっぱら OID を用いることになるか。

上記作例では 300 サンプル＋ Open Image Denoise という組み合わせで最終レンダリングを行った。これでもまだムラは残るが、これを解決しようとするなら相当にサンプル数を増やさねばならないと推測される。

## GPU メモリ問題

上記作例では GPU メモリが足りなくなる問題が多発した。明示的にエラーになるわけではないが、Recorder を使用したレンダリングをしばらく続けていると明確に処理が重くなる。Task Manager で確認する限り、GPU メモリが枯渇している場合に処理が重くなると推測される。

これを回避するために、数秒毎の短いパートに分けてレンダリングし、外部ソフト (Resolve) で編集・結合することになった。

また、8K 解像度でレンダリングしようとするとクラッシュする。これは恐らく単純なメモリ不足だろう。

このメモリ問題についてはバグ報告の必要がある。
