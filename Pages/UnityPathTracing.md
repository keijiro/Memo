# Unity DXR Path Tracing

Unity でパストレを使った感想およびノウハウ

## 本格的な作例

https://github.com/keijiro/Sketch0907

## プロシージャルモデリング

Unity DXR は `DrawMesh` 系の API に対応していないため `MeshRenderer` を介する必要がある。そのため、プロシージャルモデリングを使った複雑なシーンを扱うには以下のようなアプローチを採る必要がある。

- Game Object をたくさん作って並べる
- 結合メッシュをマイフレーム生成・更新する仕組みを作る

コード的には後者の方が簡潔にまとめやすい。ただ、どうしてもメッシュ更新のコストがかかってしまう。巨大メッシュの場合、配列コピーの負荷が無視できない規模になる模様。 New Mesh API の導入によってこれを回避できないかどうか検討中……

## マテリアル表現

個人的にはパストレによる反射・透過の表現を模索中なので、複雑なマテリアル表現については未検討。

上記作例では `TexCoord0` に発光量を仕込むことにより単一メッシュ内での自己発光表現を可能にした。こういうのをシェーダーグラフでサクッと作れるのは本当に便利。

ただ、シェーダーグラフの Custom Interpolator を使えないという弱点がある（これは意図された仕様）。本来なら自己発光量などは Custom Interpolator にすべきだが、この制約のため `TexCoord0` に入れることになった。

## GPU メモリ問題

上記作例では GPU メモリが足りなくなる問題が多発した。明示的にエラーになるわけではないが、Recorder を使用したレンダリングをしばらく続けていると明確に処理が重くなる。Task Manager で確認する限り、GPU メモリが枯渇している場合に処理が重くなると推測される。

これを回避するために、数秒毎の短いパートに分けてレンダリングし、外部ソフト (Resolve) で編集・結合することになった。

また、8K 解像度でレンダリングしようとするとクラッシュする。これは恐らく単純なメモリ不足だろう。

このメモリ問題についてはバグ報告の必要がある。
