# Stable Diffusion

しばらくしたら小慣れて使いやすくなってくるだろう……と思い、しばらくしてから覗いてみたら、想像以上に混沌としていた。

## 戦略

1. **妥協 Mac コース** - Apple Silicon MacBook 上で SD を動かす。 Apple による最適化のおかげで、そこそこのパフォーマンスを出してくれるが、それでも限界があるので、品質的にはかなりの妥協を行う必要がある。ただし、機材の運用は非常に楽であり、現場での運用には適している。
2. **そこそこ PC コース** - Mini-ITX PC 上で SD を動かす。使用できるグラボの大きさと消費電力に限界があるため、パフォーマンスにはある程度の妥協が生じる。総合的にみてコスパは最も悪いかもしれない。
3. **本気 PC コース** - ATX タワー PC を導入する。パフォーマンス的には最も高いものが実現できるが、相応の予算が必要になるし運搬も大変になるため、あまりやりたくない。
4. **クラウドコース** - GPU インスタンスを借りて SD を動かす。最も合理的な選択であるが、現場での運用に難がある。まともに使える高速なネット回線を用意できる現場というのは案外に少ない。

## Core ML Stable Diffusion

https://github.com/apple/ml-stable-diffusion

Stable Diffusion を Core ML で動かすためのパッケージ。Apple 製。

Neural Engine 対応で超高速……みたいな雰囲気を出しているが、実際には Neural Engine の効果はそれほど無いように思える。GPU 使用時と比較して速度に大きな違いは感じられない。速いっちゃ速いのだが……

使用可能なオプションにも制約がある。単に SD で遊ぶという目的の場合には、これを使うメリットはあまり無い。

アプリケーション化したい場合に、コンパクトで扱いやすいというメリットがある。iOS でも動くのは大きなメリット。

### Diffusers

https://github.com/huggingface/swift-coreml-diffusers

Apple の実装を元にしているものの、サンプラーが DPM-Solver++ に差し替えられている。少ないステップ数で高品質な結果を得ることができる（はず）。

#### ベンチマーク

- Model: Stable Diffusion v2 (base)
- Guidance scale: 7.5
- Step count: 10

|               | M1 Max MBP | M2 MBA |
| ------------- | ---------- | ------ |
| GPU           |       3.3s |   8.5s |
| Neural Engine |       6.1s |   4.4s |
| GPU + NE      |       5.6s |   5.0s |

## プロンプトエンジニアリング

https://lexica.art/

参考になるようなならないような……以前はプロンプト共有サイトというような体裁であったが、最近は独自モデルを提供しており、汎用的な AI アートサービスとして元を取る形へとピボットしたようだ。
