# Stable Diffusion

しばらくしたら小慣れて使いやすくなってくるだろう……と思い、しばらくしてから覗いてみたら、想像以上に混沌としていた。

## 戦略

1. **妥協コース** - Apple Silicon MacBook 上で SD を動かす。 Apple による最適化のおかげで、そこそこのパフォーマンスを出してくれるが、それでも限界があるので、品質的にはかなりの妥協を行う必要がある。ただし、機材の運用は最も楽であるため、現場での運用には適している。
2. **そこそこ PC コース** - Mini-ITX PC 上で SD を動かす。フォームファクタと消費電力に限界があるため、パフォーマンスはそこそこレベル。一番コスパ悪いコースかも。
3. **本気 PC コース** - ATX フルタワー PC を導入する。金がかかるし運搬も面倒なのであんまやりたくない。
4. **クラウドコース** - GPU インスタンスを借りて SD を動かす。最も合理的な選択であるが、現場での運用に問題がある。ちゃんとしたネット回線を用意できる現場というのは案外に少ない。

## Core ML Stable Diffusion

https://github.com/apple/ml-stable-diffusion

Stable Diffusion を Core ML で動かすためのパッケージ。Apple によって開発された。

Neural Engine を使うことができるので速い……みたいな雰囲気を出しているが、実際には Neural Engine の効果はそれほど無いように思える。 NE 有り・無しの場合でそれほど速度に大きな違いは無い。速いっちゃ速いのだが……

単に SD で遊ぶだけなら、このパッケージを使う必要は無さそう。アプリケーション化したい場合に、Core ML の方がコンパクトで扱いやすいというメリットがある。

### Diffusers

https://github.com/huggingface/swift-coreml-diffusers

Apple の実装を元にしているものの、サンプラーが DPM-Solver++ に差し替えられている。少ないステップ数で高品質な結果を得ることができる（はず）。

#### パフォーマンス

- Model: Stable Diffusion v2 (base)
- Guidance scale: 7.5
- Step count: 10

|               | M1 Max MBP | M2 MBA |
| ------------- | ---------- | ------ |
| GPU           |       3.3s |   8.5s |
| Neural Engine |       6.1s |   4.4s |
| GPU + NE      |       5.6s |   5.0s |

## プロンプトエンジニアリング

https://lexica.art/

参考になるようなならないような……最近は独自モデルを提供しており、それで元を取るビジネスモデルに切り替えたようだ。
