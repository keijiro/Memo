# DaVinci Resolve

## YouTube

[YouTube は BT.709 1-1-1 を前提としている](https://support.google.com/youtube/answer/1722171?hl=en#zippy=%2Ccolor-space)（これは Resolve 上の Rec.709-A に相当する）ため、普通の設定（結果的に BT.709 1-2-1 になる）で出力すると、エンコード時に色が薄くなるという現象が発生する。

これを避けるには、 Resolve 上でも Rec.709-A で編集を行う必要がある。

最も簡単なのは、[この動画](https://www.youtube.com/watch?v=8tiF-EnTlto)の設定をそのまま使うこと。

ただし、これは既に Rec.709 で調整されてしまったプロジェクトには適用できない。

既に Rec.709 で調整済みのプロジェクトを Rec.709-A に補正する正式な方法は存在しない（と思われる）。 Timeline の出力を Rec.709-A に変更したうえで、 Adjustment Clip 等を使って手動で再調整を行うしかない。

## 定型ワークフロー

### General Preferences

- General Preferences で "Use Mac display color profiles for viewers" を入れる。

### Project Settings

- Color Management Color science を "DaVinci YRGB Color Managed" に変更。
- "Automatic color management" を外す。
- Color processing mode を "HDR DaVinci Wide Gamut Intermediate" に変更。
- Output color space を "Rec.709-A" に変更。
- Master Settings を納品フォーマットに変更。
- Fairlight で Target loudness level を -13 LUFS に変更。

## Unity チュートリアル動画におけるワークフロー

### セットアップ

- ↑の定型ワークフローの設定を適用する。
- ソースデータをインポートする。

### マルチカムクリップ

- メインカメラ映像とスクリーンキャプチャ映像をマルチカムクリップにまとめて、同期を取る。これを "Tape" タイムラインとする。
- 採用音声トラックを決め、没音声トラックをすべて置換する。

### メインカメラ映像タイムライン

- メインカメラ映像のタイムラインを作成する。これを "Camera" タイムラインとする。
- 3D Keyer を使って透過設定の調整を行う。
- "Tape" のメインカメラ映像を "Camera" で置換する（入れ子のタイムライン）。

### スクリーンキャプチャ映像タイムライン

- スクリーンキャプチャ映像用のタイムラインを作成する。これを "Desktop" タイムラインとする。
- "Camera" を合成する（入れ子のタイムライン）。
- "Tape" のスクリーンキャプチャ映像を "Desktop" で置換する（入れ子のタイムライン）。

### セクション編集

- 各セクションで独立したタイムラインを作成する。とりあえず "Tape" を単純に置いておく。
- Speed Editor を使って各セクションのカット編集を行う。
- スクリーンについては各ポイントで拡大などを行う必要があるが、これは各セクションのタイムラインではなく "Desktop" 側で編集する。

### マスター統合

- 統合用のマスタータイムラインを作成する。
- とりあえず背景トラックを敷く。
- 各セクションのタイムラインをその上に合成していく。
- バンパーやエンディング、BGM などを配置していく。

## 失敗したアイデア・教訓

- Sync Bin を使ったマルチカム編集は自分には合わなかった。 Sync Bin では入れ子のタイムラインや Compound Clip を使うことができないため、コンポジット済みの素材を編集するには向いていない。チュートリアル動画などでは、クロマキー合成を行った後の素材を細かくカット編集していくことになるため、この「向いていない」ケースになる。
- ならば、コンポジット済みの素材を中間ファイルに一旦エクスポートしてから再取り込みすればいいのではないか、となるが、これはエクスポートに時間がかかるためあまり現実的ではない。１〜２時間の撮りっぱなし素材を扱うことが多いため、非常に無駄が多いワークフローとなってしまう。また、再調整のしずらさも大きな欠点。
- このように、「中間ファイルに一旦吐き出せば綺麗に解決できる」というのは、あまり良いアイデアではない。特に長弱編集には適していない。もし、どうしても中間ファイルを使いたいならば、カット編集を済ませて尺が短くなった後に行うよう、ワークフローを工夫するべき。
- 入れ子のタイムラインは非常に便利だが、あまり入れ子の中身で複雑なことをやり過ぎてしまうと、編集時のソフトウェアの動作が重くなってしまう。複雑な処理はなるべく入れ子の上段に逃がすよう工夫する。
- ループ背景素材のような単純なものに入れ子のタイムラインを使うと余計な負荷になってしまう。外部で編集を済ませておくこと。

## スクリーンキャスト録画にまつわる問題

- コンピュータ画面を Blackmagic Video Assist を使って ProRes 収録すると、単色塗りつぶしの部分に微小なディザ状のノイズを生じることがある。これが最終出力まで残った状態になると、激しいフリッカーや、不快なブロックノイズを生じる原因となる。このノイズは Temporal NR によって抑制できる。さらに Vignette 等を使って不均一な色の変化を与えると良い。

## 不安定性

- 完パケしたプロジェクトをエクスポートする際に、フレームのレンダーに失敗したとか何だとか言うエラーで、エクスポートが止まってしまうことがある。
- 原因は不明だが、 Render Cache と Fusion Effects が絡むようなシチュエーションで発生するように思われる。
- このような現象が発生した場合は、一度キャッシュを全削除してから、タイムラインを開いてキャッシュの再生成を待つ。そしてエクスポートをやり直す。
- これでもダメなら、エンコードオプションで Render Cache の使用を強制するしかない。
- 冒頭にプチノイズが入ることがある。 Noise Reduction エフェクトが悪さをしているように思われる。
- この問題は、一旦アプリを落としてからエクスポートをやり直すことで、たいてい解決してくれるが、本当にそれで確実に直るのかどうか自信は無い。

## アーカイブ化手順

- Project Manager から "Export Project Archive..." を実行。このとき Render Cache は除外しておく。
- `tar` で固める。
  - `tar --use-compress-program=pigz -c -v -f Foo.dra.tar.gz Foo.dra`

## パフォーマンス

Speed Editor を使っての編集を快適に行うには、映像ソースが intra-only コーデックでなければならない。 ProRes & BRAW の組み合わせなら問題無い。 FHD 60fps で複数ストリームの合成があっても問題なく作業できる（M1 Max MacBook の場合）。

マシンのパフォーマンスがいくら良くても GOP を伴うコーデックを直接編集に用いるとカクツキが発生してしまう。Log 撮影された UHD 映像ソースを H.264/265 で取り込む場合は、やはり proxy を用いる必要があるだろう。

## ナレーション処理についての覚え書き

- エフェクタは Limitter, Noise Reduction を使用する。 Dynamics では Limitter のみ使う。
- Noise Reduction の調整を容易にするために、まず Limitter を使って適切音量まで引き上げておく。
- EQ では残響音の抑制を目的としてピンポイントで音を削っていく。この部分はかなり奥が深く、まだコツを掴みきれていない。
- Dynamics では Limitter を使って最終的な音圧を作り出す。 -14 LUFS をキープしつつ破綻しない範囲でできる限り音量を上げていく。
- 基本的なことだが、リファレンスとの聴き比べを細かく行っていくことが肝心。耳が慣れると極端な調整を行ってしまいがち。

## Tips

- Fairlight の Noise Reduction エフェクトは逆再生のパフォーマンスを著しく低下させる。カット編集を細かく行う（いわゆる「ジェットカット」などのような）場合は、最終調整までこれを入れないようにすべき。カット編集用の入れ子のタイムラインを使った方がいいかもしれない（子のタイムラインでカット編集を行い、親のタイムラインで音の調整を行う）。
- Optimized Media を削除するには `CacheClip/Optimized Media` フォルダを[手動で削除しなければならないらしい。](https://forum.blackmagicdesign.com/viewtopic.php?f=21&t=136275#p734817)
