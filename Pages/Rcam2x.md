# Rcam2x

以前 Dommune で使用した Rcam2 のセットを更新して台湾のイベントで使用した。

## 変更点

- Unity と使用パッケージのバージョンアップ
- 使用端末の変更 (iPad -> iPhone)
- エフェクトの改良・調整
- カメラ入力に対する LUT の適用
- 背景 VFX と三人称視点モードの追加
- UI の調整
- リセットボタンの追加
- 一部スクリプトの VisualScripting への移行
- 細かなバグ修正
- その他色々……

## 機材構成

- カメラ＆コントローラー： iPhone 13 Pro Max
- レンダリング： M1 Max MacBook Pro

iPhone 14 へのアップグレードは諸々の理由（Wi-Fi 6E や USB-C など期待されている新機能への対応が無かったこと）から見送った。カメラの性能に大した差異は無いと思われるが、熱への耐性が上がっているかどうかは気になるところではある（もし長時間 60 fps が維持できるならアップグレードの価値はある）。

M1 Max MacBook Pro は、ほとんどの場面において 60 fps を維持できた。 VFX Graph で点群を扱うのに十分なスペックであると言える。ただし、Rcam2 から Rcam2x へのアップグレードにおいて DoF エフェクトを無効化したため、DoF までフルにかけた場合の GPU 負荷については検証できていない。

## 接続方法

iPhone と MacBook の接続には Lightning ケーブルを使用した。これは明文化された仕様ではないが、 MacBook と iOS デバイスを USB 接続すると２デバイス間でローカルネットワークが構築される。接続してからしばらく待つと自動 IP アドレス割り当てがなされ、普通に IP を使った通信が可能になる。複数 NIC にまつわる問題を回避するために、他の Wi-Fi 等は切っておくのが望ましい（機内モード）。

USB 接続時の通信速度は 300 Mbps 程度で、NDI を使った FHD 映像の伝送程度であれば問題なく行える。

ケーブル長を稼ぐために [UGREEN の USB リピーターケーブル](https://www.amazon.co.jp/gp/product/B07C2KWVG1)を使用した。 Lightning ケーブルは選択肢が狭いため、どうしてもこの手の延長ケーブルが必要になる。信頼性の面から考えても、リピーター（アクティブエクステンダ）の使用は必須になるだろう。

Wi-Fi を使用しない理由については[ここ](VideoProductionTips.md)に書いた通りだが、今回の現場で有線接続に問題無いことが実証でき、むしろ有線接続の方が運用上望ましいと考えるまでに至った。 5m 延長ケーブルがあれば DJ ブースを周遊する程度の動きを問題無く実現できるし、 Wi-Fi ルーター等を用意しなくとも済む分、機材構成面での利点もある。

## その他の細かな機材

ジンバルには DJI OM 5 を使用した。非常に使いやすいジンバルで、今回のような用途にも問題無く使える。唯一の問題は、外からの見た目が「自撮り棒抱えたおっさん」にしか見えないという点。 DOMMUNE のような配信専門の現場であれば問題にならないし、 Boiler Room のように DJ ブースが観客に溶け込むような感じであればまだ許されるかと思うが、今回の現場のように高いステージの上に DJ ブースがあって観客の視点が固定されてしまうような条件においては、その滑稽さが強調されてしまうことになりかねないなと思った。

## 既知の問題

AR Foundation から供給される Human Stencil と RGB カラー映像の同期がずれているように思われる。平行移動などさせてみると、常に Human Stencil の方が常に少し先行するような動きを見せるし、試しに遅延をかけてみるとピッタリと合うことから、１〜２フレームのズレがあることは確実と思われる。

ただ、この遅延がどこで発生してしまっているのか分からない。 ARKit 元来の問題なのか？ あるいは AR Foundation 側の問題なのか？ それともアプリ (Rcam2X Controller) 側か？

Human Stencil の方が遅延するならまだ分からなくもないが、逆に先行してしまうというのが奇妙。その点を考慮すると、 ARKit 側の問題であるとはなかなか考えにくい。 AR Foundation 側で何らかの問題があるか、アプリ内でのデータ取得方法に問題があるのか……

Rcam2X Controller は可変フレームレートで動いているため、固定的に１〜２フレームの遅延を挟むことでこれを解決できるとは限らない。そのため、今回は特に対処せずに許容範囲内として本番運用を行なった。

## その他トラブル

Rcam2x とは無関係であるが、今回発生したトラブルとして、4K 60 fps の出力に失敗するというものがあった。結局、今回は 30 fps にリフレッシュレートを落とすことによって解決した。

原因はよくわかっていない。どうやら会場で使用していた HDMI エクステンダ（HDMI 信号をイーサネットケーブルに乗せて長距離伝送するもの）の仕様に謎の制約があり、 Mac から 4K 60 fps 出力する場合のみ問題を生じてしまうようだった。色が紫がかってしまうような症状が現れていたので、RGB と YCbCr のミスマッチが何か発生していたのかもしれない。

この問題はこちらが持ち込んだ Apple Silicon Mac では共通して再現し、会場側の Windows PC や Intel Mac では発生していなかったので、もしかしたら Apple Silicon 依存の問題だったのかもしれない。
