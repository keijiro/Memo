# MiniBokeh パッケージ開発における AI コーディングエージェント活用の記録

https://github.com/keijiro/MiniBokeh

MiniBokeh パッケージの開発では、立ち上げからリリースまで AI コーディングエージェントを活用した。実用的なプロジェクトにおいてここまで本格的に活用したのは、個人的には初めての事例となる。

使い方としてはだいぶ保守的な手法を採っていて、開発サイクルを全自動で回すようなことは狙わず、逐一作業指示を行なって開発を進めていった。

## 使用ツール

### Claude Code

主にコーディングに用いた。通常の Max プランのため、Sonnet モデルへのフォールバックが度々発生した。

### Gemini CLI

開発を進める過程で URP や SRP Core パッケージの解析が必要になった際に利用した。単純に反応が早くて使いやすいのと、Claude のトークン節約のため。Flash へのフォールバックを避けるために API Key を使用。

### OpenAI Codex

主にドキュメント (README.md) のプルーフリードに利用した。これもトークン節約のため。ChatGPT Plus を契約しているので、実は Codex がコスト面で最も優れているが、反応が遅いため反復作業には向いていない。

## Hex ボケ実装まで

まず、最初の骨組みとなる部分は手作業で作成した。

- Render Graph を使用した Renderer Feature の基本的な実装。
- カメラ側に Controller コンポーネントを付与し、それによってパラメーター制御を行う仕組み。
- Renderer Feature 内に Blit 相当の処理を組み、それによってフルスクリーンエフェクトを適用する。
  - ただし、標準の Blit は単一テクスチャ入力しか対応していないので、Blit はカスタム実装を用いる。
- カスタム Blit 実装に対応したカスタムシェーダー。

ここまでの作業を Claude Code に行わせることも不可能ではないが、未だ Render Graph に関する知見が十分に蓄積されていないため、あまり良いものをスッとは出してくれない。これはまさに「自分で手を動かした方が早い」部分だと思う。

ここから先の実装については Claude Code に委譲。論文 PDF をワーキングディレクトリに置いて、それを参照して骨組みの中に実装するよう指示した。僅か数分で実装は完了。大きな勘違いが存在したものの、それを除けば実装にほぼ問題は無かった。

勘違いされた点：Claude Code はボケ（ブラー）処理を tent filter を使って実装してきた。レンズボケは重み付け無しに一様にサンプリングするのが正解であり、大きな特徴でもある。その基本が分かっていなかったのは、少し意外だった。

自前で用意した骨組みの方に問題があり、その後の検証で若干手間取ったものの、ここまでは難なくクリアといった感じだった。

## 最適化とリファクタリング

エフェクトが想定通り動くようになったところで Xcode のプロファイラを使って最適化を開始。動的分岐、ループ・アンロール、それらのハイブリッドなど、いくつかの選択肢を実際に実装して試してみる。こういった「ちょっと組んでみて」という作業を気軽に実施できるのは、コーディングエージェントを使った開発の良いところだと思う。ただし、計測作業は手作業で行わなければいけないので、作業時間が大幅に短縮されたという印象は無い。通常の C# コードのプロファイリングならともかくとして、モバイルデバイス上で動くシェーダーコードのプロファイリングなどは、どうすれば上手くエージェント任せにできるか現状では見当もつかないので、手作業でやらざるを得ない。

結局のところ、単純に `unroll` で `for` ループをアンロールしつつ、適宜 `conitnue` でスキップさせるアプローチが、速度と可読性の面で最も良かったので、それを採用することにした。

Half Resolution モードの実装は Claude Code に丸投げでほぼ問題無く対応できた。元画像とのブレンド方法について手作業で調整を行なったぐらいか。こういった微妙な見た目の良し悪しの判断が必要とされる部分については、どうしても人の目が介在することになる。

リファクタリングについては、手作業を交えつつ具体的な指示によって進めていく事が多かった。「このファイルをリファクタリングして」と丸投げすることも可能だが、今までの経験から言って、結果は博打になることが多かった。特に Render Graph 関連の処理は知見が少ないためか、筋の悪いコードを出力することが多いように感じる。今回のパッケージは最終的に自分でメンテナンスできる状態を実現したかったので、自分の読みやすいコードへと書き換えてもらう作業を行なっていくことになった。

## 円形ボケの実装

次に kecho 氏に提案された、複素数カーネルを使用した円形ボケの実装を行うことにした。これは非常に賢い手法で、円形のボケを単純な separable filter として実装できる。ただし複素数が絡んでくるため、帯域幅は倍増する（テクスチャ数を増やさざるを得ないので倍増以上か）。

実装にあたっては、参考となる Shadertoy の glsl をサブディレクトリに配置し、ついでに論文の PDF も置いたうえで、それを追加機能として実装することを Claude Code に依頼した。複素数カーネル配列の解釈に混乱があり、最初はうまく動かなかった。カーネルの `float4` 配列のうち `.xy` 成分だけを利用する、という、少し直感的ではない仕様だったのが問題だったようだ。丸投げで完遂できたら楽だなと思っていたが、この勘違いを直すためにちゃんと処理内容を把握する必要が生じ、やはり手抜きはできないものだなと痛感した。最終的に勘違いに気づき、修正を指示して解決。もっと Claude Code を酷使すれば自力解決もできたのかもしれないが、どうせリファクタリングを行う際にコードの理解は必要になるので、この程度の回り道はしょうがないのかもしれない。

次に MRT (multiple render target) を使用した最適化を行う。複素数 R/G/B 要素を扱うのに３枚のテクスチャを扱う必要があり、MRT を使えばこれを単一パスで処理できるので、総パス数を大幅に軽減できる。Render Graph 内で MRT を使用する知見も不足しているので、これも無理せず手作業で骨組みを用意した。MRT に対応したカスタム Blit を用意したうえで、これを使用して現状の実装を最適化せよ、というような指示を行い、これは問題なく完遂された。

シェーダーコードが長くなってきたので複数の `.hlsl` ファイルに分割。この辺りの作業も具体的に指示を行えば難なく行なってくれる。

## UI/UX

エディタコード (Inspector) については Claude Code に丸投げで完了。この辺りは Claude も慣れたもので、今回のような簡単な構成なら丸投げで十分と感じる。

プロパティの仕様については、実際に作業を行いながら気づいた点をまとめ、ここはこうした方が良い、というような指示を Claude Code に対して行うことで改良を進めていった。 Bokeh Strength と Max Blur Radius の値の反映のされ方などに、その辺りが反映されている。

## 細かな調整

サンプルを作成しているうちに、画面端が暗くなることが気になり始めたので（アーティファクトを避けるために画面外テクセルは黒とする処理を組み込んであった）、これに対処するための Boundary Fade プロパティを追加した。これを実装する過程で、単純な UV クランプや UV ミラーリングなども試したが、UV ミラーリングについて Claude Code が全く的外れなコードを出力してきたのが驚きだった。UV 座標の扱いについてはこれまでにも何度かしくじることがあり、何故かは分からないが不得手な部類にあるようだった。もしかしたら Opus モデルなら問題無いのかもしれないが……

## ドキュメント (README)

README.md ファイルについては、まず最初に自力で（broken English で）執筆し、それを Codex に清書してもらうという流れで作成した。丸投げで生成することを避けたのは、丸投げするとたいてい冗長な文書が生成されるというのと、Unity ユーザー的に欲しい要点を最初に押さえておきたかったという理由がある。

Codex には事前にソースコードを読んでもらっていたが、それでもいくつか解釈の間違っている部分があり、清書されたものを更に直したうえで、もう一度清書してもらうという工程が必要だった。

## 全般を通して感じた瑣末なこと

- Claude Code は空行にインデント分のスペースを入れてしまう挙動があり、それが煩わしいと感じる。`CLAUDE.md` に trailing whitespace は入れるべからずと指示してあり、指摘すれば直してくれるのだが、最初から入れないようにしてくれれば良いのに……と常に思っている。
- Codex は日本語で指示しても英語で返答されることが多い。他のエージェントは、こちらが日本語を使うとそれに合わせて返答も日本語になるのだが、Codex だけは英語を突き通してくることが多い（たまに日本語になることもある）。大きな問題とは感じていないが、Codex だけがこうなので少し気になっている。
- Claude Code は常に前セッションをレジュームする形で運用しているが、巷でよく言われる「次第に頭が悪くなってくる」現象を、やはり自分も感じている。単に Sonnet へのフォールバックが悪影響を及ぼしているだけかもしれないが、いずれにせよ「使い始めが一番滑らかに作業できる」のは確か。
